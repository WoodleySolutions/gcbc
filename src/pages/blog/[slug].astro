---
import Layout from '../../layouts/Layout.astro';
import { client, queries, urlFor, type BlogPost } from '../../lib/sanity';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = await client.fetch(`*[_type == "blogPost"]{ slug }`);

  return posts.map((post: any) => ({
    params: { slug: post.slug.current }
  }));
};

const { slug } = Astro.params;

// Fetch the blog post
const post: BlogPost = await client.fetch(queries.postBySlug(slug!));

if (!post) {
  return Astro.redirect('/blog');
}

// Helper function to format dates
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Helper function to render Sanity block content
const renderBlockText = (blocks: any[]) => {
  return blocks
    .filter((block) => block._type === 'block')
    .map((block) => {
      return block.children
        ?.filter((child: any) => child._type === 'span')
        .map((span: any) => span.text)
        .join('');
    })
    .join('\n\n');
};

const pageTitle = post.seo?.metaTitle || post.title;
const pageDescription = post.seo?.metaDescription || post.excerpt;

// Generate featured image URL for structured data
const featuredImageUrl = post.postType === 'video' && post.youtubeVideo
  ? `https://img.youtube.com/vi/${post.youtubeVideo.videoId}/maxresdefault.jpg`
  : post.featuredImage
  ? urlFor(post.featuredImage).width(1200).height(630).url()
  : null;

// Structured data for SEO (Schema.org)
const structuredData = {
  "@context": "https://schema.org",
  "@type": post.postType === 'video' ? "VideoObject" : "BlogPosting",
  "headline": post.title,
  "description": pageDescription,
  "author": {
    "@type": "Person",
    "name": post.author || "Great Catholic Book Club"
  },
  "datePublished": post.publishedAt,
  "publisher": {
    "@type": "Organization",
    "name": "Great Catholic Book Club",
    "logo": {
      "@type": "ImageObject",
      "url": "https://greatcatholicbookclub.com/GCBC_Logo_ForDarkBG.png"
    }
  },
  ...(featuredImageUrl && { "image": featuredImageUrl }),
  ...(post.postType === 'video' && post.youtubeVideo && {
    "name": post.title,
    "uploadDate": post.publishedAt,
    "thumbnailUrl": `https://img.youtube.com/vi/${post.youtubeVideo.videoId}/maxresdefault.jpg`,
    "embedUrl": `https://www.youtube.com/embed/${post.youtubeVideo.videoId}`,
    ...(post.youtubeVideo.duration && { "duration": post.youtubeVideo.duration })
  })
};
---

<Layout title={`${pageTitle} - Great Catholic Book Club`} description={pageDescription}>
  <!-- Structured Data for SEO -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  <!-- Blog Post Header -->
  <section class="bg-black-olive relative pt-16 pb-8">
    <div class="max-w-4xl mx-auto px-4">
      <div class="text-center">
        <h1 class="text-4xl sm:text-5xl font-bold text-champaign-100 mb-4 font-headline drop-shadow-lg">
          {post.title}
        </h1>
        <div class="flex justify-center items-center gap-4 text-champaign-300 mb-6">
          <span>By {post.author || 'Great Catholic Book Club'}</span>
          <span>â€¢</span>
          <time datetime={post.publishedAt}>{formatDate(post.publishedAt)}</time>
        </div>
        {post.categories && post.categories.length > 0 && (
          <div class="flex justify-center gap-2 flex-wrap">
            {post.categories.map((category) => (
              <span class="bg-rust-800 text-champaign-100 px-3 py-1 rounded-full text-sm">
                {category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
              </span>
            ))}
          </div>
        )}
      </div>
    </div>
  </section>

  <!-- Featured Image or Video -->
  {post.postType === 'video' && post.youtubeVideo ? (
    <section class="bg-black-olive pb-8">
      <div class="max-w-4xl mx-auto px-4">
        <div class="aspect-video rounded-lg overflow-hidden shadow-2xl">
          <iframe
            src={`https://www.youtube.com/embed/${post.youtubeVideo.videoId}?rel=0&modestbranding=1`}
            title={post.title}
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            class="w-full h-full"
          ></iframe>
        </div>
        {post.youtubeVideo.duration && (
          <div class="text-center mt-2">
            <span class="text-champaign-300 text-sm">Duration: {post.youtubeVideo.duration}</span>
          </div>
        )}
      </div>
    </section>
  ) : post.featuredImage && (
    <section class="bg-black-olive pb-8">
      <div class="max-w-4xl mx-auto px-4">
        <div class="aspect-video rounded-lg overflow-hidden shadow-2xl">
          <img
            src={urlFor(post.featuredImage).width(800).height(450).url()}
            alt={post.title}
            class="w-full h-full object-cover"
          />
        </div>
      </div>
    </section>
  )}

  <!-- Blog Content -->
  <section class="py-16 bg-black-olive">
    <div class="max-w-4xl mx-auto px-4">
      <article class="prose prose-lg prose-invert max-w-none">
        <div class="bg-black-olive border border-champaign-700/30 rounded-lg p-8 shadow-2xl">
          <!-- Content -->
          <div class="space-y-6">
            {post.content && (
              <div class="text-champaign-200 leading-relaxed whitespace-pre-line text-lg">
                {renderBlockText(post.content)}
              </div>
            )}
          </div>

          <!-- Tags -->
          {post.tags && post.tags.length > 0 && (
            <div class="mt-12 pt-8 border-t border-champaign-700/30">
              <h3 class="text-lg font-semibold text-champaign-100 mb-4">Tags:</h3>
              <div class="flex gap-2 flex-wrap">
                {post.tags.map((tag) => (
                  <span class="bg-black-olive border border-champaign-700/30 text-champaign-300 px-3 py-1 rounded-full text-sm">
                    #{tag}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>
      </article>
    </div>
  </section>

  <!-- Related Books -->
  {post.relatedBooks && post.relatedBooks.length > 0 && (
    <section class="py-16 bg-rust-800">
      <div class="max-w-6xl mx-auto px-4">
        <h2 class="text-3xl font-bold text-champaign-100 text-center mb-12 font-headline">Related Books</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {post.relatedBooks.map((book) => (
            <div class="bg-black-olive border border-champaign-700/30 rounded-lg p-6 shadow-xl text-center">
              {book.coverImage && (
                <div class="aspect-[3/4] mb-4 mx-auto max-w-48">
                  <img
                    src={urlFor(book.coverImage).width(200).height(267).url()}
                    alt={book.title}
                    class="w-full h-full object-cover rounded"
                  />
                </div>
              )}
              <h3 class="text-lg font-bold text-champaign-100 mb-2">{book.title}</h3>
              <p class="text-champaign-200 text-sm">By {book.author}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Call to Action -->
  <section class="py-16 bg-black-olive">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <div class="bg-black-olive border border-champaign-700/30 rounded-lg p-8 shadow-2xl">
        <h2 class="text-2xl font-bold text-champaign-100 mb-4 font-headline">Join the Discussion</h2>
        <p class="text-champaign-200 mb-6">
          Ready to explore more books through the Catholic lens? Join our book club community!
        </p>
        <div class="flex justify-center gap-4 flex-wrap">
          <a href="/books" class="inline-block bg-rust-800 text-champaign-100 px-6 py-3 rounded-lg font-semibold hover:bg-rust-900 transition-colors">
            View Reading List
          </a>
          <a href="/join" class="inline-block bg-champaign-100 text-rust-800 px-6 py-3 rounded-lg font-semibold hover:bg-champaign-200 transition-colors">
            Join Book Club
          </a>
          <a href="/blog" class="inline-block bg-black-olive border border-champaign-700/30 text-champaign-100 px-6 py-3 rounded-lg font-semibold hover:bg-champaign-700/10 transition-colors">
            More Blog Posts
          </a>
        </div>
      </div>
    </div>
  </section>
</Layout>