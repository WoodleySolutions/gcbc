---
import Layout from '../layouts/Layout.astro';
import { getCurrentEventText } from '../lib/currentEvent';
import { client, queries, urlFor, type MonthlyBook } from '../lib/sanity';

const eventText = getCurrentEventText();

// Fetch all monthly books and current book from CMS
const [books, currentBook] = await Promise.all([
  client.fetch(queries.allBooks),
  client.fetch(queries.currentBook)
]);

// Helper function to format month names
const formatMonthName = (month: string) => {
  const monthMap: { [key: string]: string } = {
    january: 'January',
    february: 'February',
    march: 'March',
    april: 'April',
    may: 'May',
    june: 'June',
    july: 'July',
    august: 'August',
    september: 'September',
    october: 'October',
    november: 'November',
    december: 'December'
  };
  return monthMap[month.toLowerCase()] || month;
};

// Helper function to format meeting dates
const formatMeetingDate = (dateString: string) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return `${date.getMonth() + 1}/${date.getDate()}`;
};
---

<Layout title="2025 Book List - Great Catholic Book Club">
  <!-- Header Section -->
  <section class="bg-black-olive relative">
    <div class="absolute inset-0 bg-gradient-to-b from-black-olive via-black-olive to-black-olive opacity-95"></div>
    <div class="max-w-7xl mx-auto px-4 py-16 relative z-10">
      <div class="text-center">
        <h1 class="text-4xl sm:text-5xl font-bold text-champaign-100 mb-4 font-headline drop-shadow-lg">
          2025 Book List
        </h1>
        <p class="text-2xl text-rust-400 font-semibold mb-8 font-headline">
          Theme: Protoevangelium
        </p>
      </div>
    </div>
  </section>

  <!-- Introduction Section -->
  <section class="py-16 bg-black-olive">
    <div class="max-w-4xl mx-auto px-4">
      <div class="bg-black-olive border border-champaign-700/30 rounded-lg p-8 mb-8 shadow-2xl">
        <h2 class="text-2xl font-bold text-champaign-100 mb-6 font-headline">About Our 2025 List</h2>
        <p class="text-lg text-champaign-200 mb-6 leading-relaxed">
          Our inaugural 2025 list features the books that introduced us to the ideas that helped us come to understand and embrace the Gospel. These are our beloved favorites, as sci-fi nerds and products of the pop culture of the early 2000's. We can look back now and appreciate the beautiful Christian truths in them!
        </p>
        <p class="text-lg text-champaign-200 mb-6 leading-relaxed">
          The list contains Amazon affiliate links. If you choose to buy the books through our links, we could receive some payment. We'd appreciate the support. But you can also get the books from your local library for free, or your local used bookstore for cheap. Do whatever works--we just want to enjoy discussing them with you!
        </p>
        <p class="text-lg text-champaign-200 leading-relaxed">
          {eventText.joinPrompt} {eventText.scheduleText} {eventText.joinNowText}
        </p>
      </div>
    </div>
  </section>

  <!-- Current Book Banner -->
  {currentBook && (
    <section class="py-12 bg-rust-800">
      <div class="max-w-6xl mx-auto px-4">
        <div class="bg-black-olive border border-champaign-700/30 rounded-lg p-8 shadow-2xl">
          <div class="grid md:grid-cols-4 gap-8 items-center">
            <div class="text-center">
              <h3 class="text-2xl font-bold text-champaign-100 mb-2 font-headline">Current Book</h3>
              <p class="text-rust-400 font-semibold">
                {formatMonthName(currentBook.month)} {currentBook.year}
              </p>
              {currentBook.meetingDate && (
                <p class="text-champaign-300 text-sm mt-1">
                  Meeting: {formatMeetingDate(currentBook.meetingDate)}
                </p>
              )}
            </div>
            <div class="aspect-[3/4] bg-black-olive border border-champaign-700/20 rounded-lg shadow-inner overflow-hidden">
              {currentBook.coverImage ? (
                <img
                  src={urlFor(currentBook.coverImage).width(300).height(400).url()}
                  alt={currentBook.title}
                  class="w-full h-full object-cover"
                />
              ) : (
                <div class="w-full h-full flex items-center justify-center text-champaign-300 text-center p-4">
                  <span class="text-sm">No Cover Available</span>
                </div>
              )}
            </div>
            <div class="md:col-span-2">
              <h4 class="text-2xl font-bold text-champaign-100 mb-2 font-headline">{currentBook.title}</h4>
              <p class="text-champaign-200 mb-2 text-lg">By {currentBook.author}</p>
              {currentBook.theme && (
                <p class="text-rust-400 font-semibold font-headline mb-4">{currentBook.theme}</p>
              )}
              {currentBook.description && (
                <p class="text-champaign-200 mb-6 leading-relaxed">{currentBook.description}</p>
              )}
              <div class="flex flex-wrap gap-4">
                {currentBook.amazonLink && (
                  <a
                    href={currentBook.amazonLink}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-block bg-rust-600 text-champaign-100 px-6 py-3 rounded-lg font-semibold hover:bg-rust-700 transition-colors"
                  >
                    Get the Book
                  </a>
                )}
                <a
                  href="/join"
                  class="inline-block bg-champaign-100 text-rust-800 px-6 py-3 rounded-lg font-semibold hover:bg-champaign-200 transition-colors"
                >
                  Join Discussion
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Book List Section -->
  <section class="py-16 bg-black-olive">
    <div class="max-w-6xl mx-auto px-4">
      <h2 class="text-3xl font-bold text-champaign-100 text-center mb-12 font-headline">Monthly Reading Schedule</h2>

      <div class="grid gap-8">
        {books.map((book) => (
          <div class="bg-black-olive border border-champaign-700/30 rounded-lg p-6 shadow-2xl">
            <div class="grid md:grid-cols-4 gap-6 items-center">
              <div class="text-center">
                <div class="text-2xl font-bold text-rust-400 mb-2 font-headline">
                  {formatMonthName(book.month)}
                </div>
                {book.meetingDate && (
                  <div class="text-champaign-300">
                    {formatMeetingDate(book.meetingDate)}
                  </div>
                )}
              </div>
              <div class="aspect-[3/4] bg-black-olive border border-champaign-700/20 rounded-lg shadow-inner overflow-hidden">
                {book.coverImage ? (
                  <img
                    src={urlFor(book.coverImage).width(300).height(400).url()}
                    alt={book.title}
                    class="w-full h-full object-cover"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center text-champaign-300 text-center p-4">
                    <span class="text-sm">No Cover Available</span>
                  </div>
                )}
              </div>
              <div class="md:col-span-2">
                <h3 class="text-xl font-bold text-champaign-100 mb-2 font-headline">{book.title}</h3>
                <p class="text-champaign-200 mb-2">By {book.author}</p>
                {book.theme && (
                  <p class="text-rust-400 font-semibold font-headline">{book.theme}</p>
                )}
                {book.description && (
                  <p class="text-champaign-300 text-sm mt-3 leading-relaxed">{book.description}</p>
                )}
                {book.amazonLink && (
                  <div class="mt-4">
                    <a
                      href={book.amazonLink}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-block bg-rust-800 text-champaign-100 px-4 py-2 rounded text-sm font-semibold hover:bg-rust-900 transition-colors"
                    >
                      Buy on Amazon
                    </a>
                  </div>
                )}
              </div>
            </div>
            {book.discussionQuestions && book.discussionQuestions.length > 0 && (
              <div class="mt-6 pt-6 border-t border-champaign-700/30">
                <h4 class="text-lg font-semibold text-champaign-100 mb-3 font-headline">Sample Discussion Questions:</h4>
                <div class="space-y-2">
                  {book.discussionQuestions.slice(0, 3).map((question, index) => (
                    <p class="text-champaign-200 text-sm leading-relaxed">
                      <span class="text-rust-400 font-semibold">{index + 1}.</span> {question}
                    </p>
                  ))}
                  {book.discussionQuestions.length > 3 && (
                    <p class="text-champaign-300 text-xs italic">
                      ...and {book.discussionQuestions.length - 3} more questions in our study guide
                    </p>
                  )}
                </div>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Call to Action -->
  <section class="py-16 bg-rust-800 text-champaign-100">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h2 class="text-3xl font-bold mb-4 font-headline">Ready to Join the Discussion?</h2>
      <p class="text-champaign-200 mb-8 text-lg">
        Sign up now to get the 2025 Study Guide and participate in our monthly meetings!
      </p>
      <a href="/join" class="inline-block bg-champaign-100 text-rust-800 px-8 py-3 rounded-lg text-lg font-semibold hover:bg-champaign-200 transition-colors shadow-md">
        Join the Book Club
      </a>
    </div>
  </section>
</Layout>